<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–õ–µ–Ω—Ç–∞ ‚Äî Asador</title>
<style>
body { font-family: sans-serif; background:#f5f5f5; margin:0; padding:0; }
h2 { text-align:center; }
.post { background:white; margin:10px auto; padding:10px; max-width:400px; border-radius:10px; box-shadow:0 1px 3px rgba(0,0,0,0.1);}
.logout, .switch { display:block; text-align:center; margin:10px; cursor:pointer; font-weight:bold; }
.logout { color:red; }
.switch { color:blue; }
#newPost { max-width:400px; margin:10px auto; display:flex; flex-direction:column; }
#newPost textarea { resize:none; padding:5px; margin-bottom:5px; }
#loader { text-align:center; margin-top:10px; }
</style>
</head>
<body>
<h2>–õ–µ–Ω—Ç–∞</h2>

<div id="loader">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
<div id="feed"></div>

<div id="newPost">
<textarea id="postText" rows="3" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
<button onclick="addPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
</div>

<span class="switch" onclick="switchAccount()">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</span>
<span class="logout" onclick="logout()">–í—ã–π—Ç–∏</span>

<script>
async function loadFeed() {
  const loader = document.getElementById("loader");
  const container = document.getElementById("feed");
  loader.style.display = "block";
  container.innerHTML = "";
  try {
    const res = await fetch("/feed");
    if (res.status === 401) { window.location.href = "/index.html"; return; }
    const posts = await res.json();
    loader.style.display = "none";
    if (!posts.length) { container.innerHTML="<p style='text-align:center;color:gray;'>–ü–æ—Å—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>"; return; }
    posts.forEach(p => {
      const div = document.createElement("div");
      div.className = "post";
      div.innerHTML = `<b>${p.username}</b><br/>${p.text}<br/>‚ù§Ô∏è ${p.likes} ‚Ä¢ üí¨ ${p.comments}`;
      container.appendChild(div);
    });
  } catch (e) { loader.innerText="–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"; console.error(e); }
}

async function addPost() {
  const text = document.getElementById("postText").value.trim();
  if (!text) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç");
  const res = await fetch("/feed/add", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text})
  });
  const data = await res.json();
  if (data.success) {
    document.getElementById("postText").value="";
    loadFeed();
  } else alert(data.message);
}

function logout() {
  document.cookie="sessionId=; Max-Age=0; path=/";
  window.location.href="/index.html";
}

function switchAccount() {
  const accounts = JSON.parse(localStorage.getItem("accounts")||"[]");
  if (accounts.length<=1) return alert("–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤");
  const names = accounts.map(a=>a.username).join("\n");
  const username = prompt("–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç:\n"+names);
  if (username) {
    document.cookie="sessionId=; Max-Age=0; path=/";
    alert("–í—ã–π–¥–∏—Ç–µ –∏ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –ª–æ–≥–∏–Ω –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞");
    window.location.href="/index.html";
  }
}

loadFeed();
</script>
</body>
</html>
